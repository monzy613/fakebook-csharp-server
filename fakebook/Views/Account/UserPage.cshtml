<!DOCTYPE html>
<html>
<head lang="en">
    @using fakebook.Models
    @model FriendModel
    <meta charset="UTF-8">
    <title>Text | FakeBook</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <!--link rel="alternate icon" type="image/png" href="assets/i/favicon.png"-->
    <link rel="stylesheet" href="@Url.Content("~/Assets/css/amazeui.min.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Assets/css/admin.css")" />
    <style>
        .header {
            text-align: center;
        }

            .header h1 {
                font-size: 200%;
                color: #333;
                margin-top: 30px;
            }

            .header p {
                font-size: 14px;
            }

        #borderColorCorner {
            border: 10px solid #dedede;
        }

          padding: 15px 25px; 　　 height: inherit; 　　 width: 590px; 　　
        }
    </style>
</head>
<body>
    <header class="am-topbar admin-header" style="background-color: #1E5B94">
        <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only" data-am-collapse="{target: '#topbar-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button>
        <div class="am-collapse am-topbar-collapse am-u-md-6" id="topbar-collapse">
            <ul class="am-nav am-nav-pills am-topbar-nav am-topbar-middle admin-header-list">
                <li>
                    <a href="UserPage">
                        <span class="am-icon-man-o" style="color:#000; font-size: 18px;font-family:'微软雅黑'">
                            主页
                        </span>
                    </a>
                </li>
                <li>
                    <a href="Text">
                        <span class="am-icon-man-o" style="color:#000; font-size: 18px;font-family:'微软雅黑'">
                            朋友圈
                        </span>
                    </a>
                </li>
                <li>
                    <a href="../Album/Gallery">
                        <span class="am-icon-man-o" style="color:#000; font-size: 18px;font-family:'微软雅黑'">
                            相册
                        </span>
                    </a>
                </li>
                <li>
                    <a href="../Topic/Index">
                        <span class="am-icon-man-o" style="color:#000; font-size: 18px;font-family:'微软雅黑'">
                            话题
                        </span>
                    </a>
                </li>
                <li>
                    <a href="Chatroom">
                        <span class="am-icon-man-o" style="color:#000; font-size: 18px;font-family:'微软雅黑'">
                            多人聊天室
                        </span>
                    </a>
                </li>
                <li>
                    <a href="PeopleAround" style="color:#000; font-size: 18px;font-family:'微软雅黑'">
                        <span class="am-icon-man-o">
                            附近的人
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#friend-side-bar" data-am-offcanvas>
                        <span class="am-icon-man-o" style="color:#000; font-size: 18px;font-family:'微软雅黑'">
                            小伙伴们
                        </span>
                    </a>
                </li>

            </ul>
            <form class="am-topbar-form am-u-md-4 am-u-sm-10">
                <div class="">
                    <div class="am-input-group am-input-group-primary">
                        <span class="am-input-group-btn">
                            <a href="Search"><button class="am-btn am-btn-primary search-button" type="button"><span class="am-icon-search"></span></button></a>
                        </span>
                    </div>
                </div>
            </form>



        </div>


    </header>
    <!--TEST start-->
    <!--TEST end-->

    <div class="am-cf admin-main am-u-sm-centered">
        <!-- content start -->
        <div class="admin-content" id="maindiv">

            <div class="am-cf am-padding">
                <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">个人资料</strong> / <small>Personal information</small></div>
            </div>
            <hr />
            <div class="am-g">

                <!--head img start-->
                <div class="am-u-sm-12 am-u-md-3">
                    <div class="am-panel am-panel-default">
                        <div class="am-panel-bd">
                            <div class="am-g">
                                <div class="am-u-md-12">
                                    <img class="am-img-circle am-img-thumbnail" src="@Url.Content(ViewBag.headimg)" alt="" />
                                </div>
                                <div align=center class="am-badge am-badge-secondary">
                                    @ViewBag.username
                                </div>

                                <input type="button" class="am-btn am-btn-primary am-fr" value="修改" onclick="location.href ='/Account/Modify'">

                                @using (Html.BeginForm("ChangeHeadImage", "UpLoadPic", FormMethod.Post, new { enctype = "multipart/form-data" }))
                                {
                                    <input type="file" name="picture" />
                                    <input type="submit" value="上传图片" />
                                }


                            </div>
                        </div>
                    </div>
                </div>
                <!--head img end-->



                <div class="am-u-sm-12 am-u-md-8">

                    <div class="am-form-group">
                        <label for="name" class="am-u-sm-3 am-form-label">姓名 / Name</label>
                        <div class="am-u-sm-9">
                            <label class="am-form-label"><%=nickname%></label>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="user-email" class="am-u-sm-3 am-form-label">电子邮件 / Email</label>
                        <div class="am-u-sm-9">
                            <label class="am-form-label"><%=email%></label>
                        </div>
                    </div>

                    <div class="am-form-group">
                        <label for="user-QQ" class="am-u-sm-3 am-form-label">QQ</label>
                        <div class="am-u-sm-9">
                            <label class="am-form-label"><%=qq%></label>
                        </div>
                    </div>


                    <!--           <div class="am-form-group">
                                <div class="am-u-sm-9 am-u-sm-push-3">
                                  <button type="button" class="modify-button am-btn am-btn-primary am-fr">Login</button>
                                </div>
                              </div> -->
                </div>




                <!-- 侧边栏内容 -->
                <div id="friend-side-bar" class="am-offcanvas">
                    <div class="am-offcanvas-bar">
                        <div class="am-offcanvas-content">
                            <ul class="am-list" id="friendlist">
                                @if (ViewData["friendList"] != null)
                                {
                                    foreach (FriendModel i in (ViewData["friendList"] as List<FriendModel>))
                                    {

                                        <li>
                                            <div class="am-u-sm-12 am-panel">
                                                <div class="am-panel-bd am-u-sm-6">
                                                    <div class="am-g">

                                                        <div class="am-u-md-12">
                                                            <img class="am-img-circle am-img-thumbnail" src="@Url.Content("~/Assets/Img/headImg.jpg")" alt="" />
                                                        </div>
                                                        <div class="am-badge am-badge-secondary am-u-centered">
                                                            @i.nickname
                                                        </div>

                                                    </div>
                                                </div>
                                                <div class="buttongroup am-u-sm-6 am-panel-bd">
                                                    <button class="am-u-sm-12 am-btn am-btn-primary am-margin-bottom" data-id="@i._id" onclick="initChat(this)">唠嗑</button>
                                                    <button class="am-u-sm-12 am-btn am-btn-danger">友尽</button>
                                                </div>
                                            </div>
                                        </li>



                                    }
                                }


                            </ul>
                        </div>
                    </div>
                </div>

            </div>
            <!-- content end -->
        </div>
    </div>
    <!-- <a class="am-icon-btn am-icon-th-list am-show-sm-only admin-menu" data-am-offcanvas="{target: '#admin-offcanvas'}"></a> -->
    <footer class="footer">
        <br />
        <hr>
        <p class="am-padding-left" align=center>fakebook Tongji</p>
    </footer>
    <script src="@Url.Content("~/Assets/js/jquery.min.js")"></script>
    <script src="@Url.Content("~/Assets/js/amazeui.min.js")"></script>
    <script src="@Url.Content("~/Assets/js/app.js")"></script>
    <script>










        /*
                      <li>
                        <div class="am-u-sm-12 am-panel">
                          <div class="am-panel-bd am-u-sm-6">
                            <div class="am-g">

                              <div class="am-u-md-12">
                                <img class="am-img-circle am-img-thumbnail" src="head_imgs/<%=head_img_name%>" alt=""/>
                              </div>
                              <div class="am-badge am-badge-secondary am-u-centered">
                                <%=username%>
                              </div>

                            </div>
                          </div>
                          <div class="buttongroup am-u-sm-6 am-panel-bd">
                            <button class="am-u-sm-12 am-btn am-btn-primary am-margin-bottom">唠嗑</button>
                            <button class="am-u-sm-12 am-btn am-btn-danger">友尽</button>
                          </div>
                        </div>
                      </li>
        */











        /*
        div<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-chatwindow-monzy123">
          div1<div class="am-modal-dialog">
            div11<div class="am-modal-hd">
              <small>monzy613</small>
              <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            div12<div class="am-modal-bd am-cf">
              div121<div class="am-u-sm-12">
                <textarea class="chatarea am-u-sm-12" rows="5">nothing</textarea>
                <input type=text class="am-u-sm-10 am-margin-top-xs" style="height:30px">
                <button class="am-u-sm-2 am-btn am-btn-primary am-margin-top-xs" style="height:30px"  onclick="send()">Go</button>
              </div>
            </div>
          </div>
        </div>
        */

        /*
         function send (friendID) {
           var msg = $('.msgarea-' + friendID).val();
           $('.msgarea-' + friendID).val('');
           var send_package = {
             friendID: friendID,
             msg: msg
           };
           $.post ('/p2pchat', send_package);
           console.log ('send to ' + friendID + " " + send_package.msg);
         }
         */

        var currentChatID = "";

        function send(friendID) {

            /*
            send package
            {
                senderID:
                receiverID:
                content:
            }
            */

            var content = $('.msgarea-' + friendID).val();
            $('.msgarea-' + friendID).val('');
            if(content !== "") {
                var sendStr = "{\"sender\":\"" + @ViewBag.username
                            + "\",\"receiver\":\"" + currentChatID
                            + "\",\"content\":\"" + content
                            + "\"}";
                if ($('.chatarea-' + currentChatID).val() !== '') {
                    $('.chatarea-' + currentChatID).val($('.chatarea-' + currentChatID).val() + '\n' + "@ViewBag.username" + ": " + content);
                } else {
                    $('.chatarea-' + currentChatID).val("@ViewBag.username" + ": " + content);
                }
                ws.send(sendStr);
            }                
        }   



        /*
        <button class="am-btn am-btn-danger" data-am-modal="{target: '#my-popup'}">Popup</button>
        <div class="am-popup" id="my-popup">
          <div class="am-popup-inner">
            <div class="am-popup-hd">
              <h4 class="am-popup-title">...</h4>
              <span data-am-modal-close
                    class="am-close">&times;</span>
            </div>
            <div class="am-popup-bd">
              ...
            </div>
          </div>
        </div>
        */


 function initChat(btn) {
   var friendID = btn.getAttribute('data-id');
   currentChatID = friendID;
   console.log ('new chat with ' + currentChatID);
   btn.setAttribute('data-am-modal', '{target: "#doc-modal-chatwindow-' + friendID +  '", closeViaDimmer: 0, width: 400, height: 225}');

   tm = document.getElementById('maindiv');

   var div = document.createElement('div');
   div.setAttribute('class', 'am-popup am-modal-no-btn');
   div.setAttribute('tabindex', '-1');
   div.setAttribute('id', 'doc-modal-chatwindow-' + friendID);

   var div1 = document.createElement('div');
   div1.setAttribute('class', 'am-popup-inner');

   var div11 = document.createElement('div');
   div11.setAttribute('class', 'am-popup-hd');





   var h4 = document.createElement('h4');
   h4.setAttribute('class', 'am-popup-title');
   h4.innerHTML = friendID;

   var small = document.createElement('small');
   small.innerHTML = friendID;

   var close = document.createElement('span');
   close.setAttribute('data-am-modal-close', '');
   close.setAttribute('class', 'am-close');
   close.setAttribute('onclick', 'deleteChatWith("' + friendID + '")');
   close.innerHTML = '&times;';


   var div12 = document.createElement('div');
   div12.setAttribute('class', 'am-popup-bd');

   var div121 = document.createElement('div');
   div121.setAttribute('class', 'am-u-sm-12');

   var chatarea = document.createElement('textarea');
   chatarea.setAttribute('class', 'am-u-sm-12 am-margin-top-sm chatarea-' + friendID);
   chatarea.setAttribute('rows', '20');

   var input = document.createElement('input');
   input.setAttribute('type', 'text');
   input.setAttribute('class', 'am-u-sm-10 am-margin-top-xs msgarea-' + friendID);
   input.setAttribute('style', 'height:40px');

   var sendBtn = document.createElement('button');
   sendBtn.setAttribute('class', 'am-u-sm-2 am-btn am-btn-primary am-margin-top-xs');
   //sendBtn.setAttribute('style', 'height:30px');
   sendBtn.setAttribute('onclick', 'send("' + friendID + '")');
   sendBtn.innerHTML = 'Go';

   div11.appendChild(h4);
   div11.appendChild(close);

   div121.appendChild(chatarea);
   div121.appendChild(input);
   div121.appendChild(sendBtn);

   div12.appendChild(div121);

   div1.appendChild(div11);
   div1.appendChild(div12);

   div.appendChild(div1);
   tm.appendChild(div);
 }



function deleteChatWith (friendID) {
    tm = document.getElementById('maindiv');
    tm.removeChild(document.getElementById('doc-modal-chatwindow-' + friendID));
}





        // $('#doc-modal-chatwindow-' + currentChatID).on('closed.modal.amui', function(){
        //   alert (currentChatID + ' chat modal');
        // });












var start = function () {
    var wsImpl = window.WebSocket || window.MozWebSocket;
    // create a new websocket and connect
    window.ws = new wsImpl('ws://localhost:8182/');

    // when data is comming from the server, this metod is called
    ws.onmessage = function (evt) {
        //inc.innerHTML += evt.data + '\n';
        var strJSON = evt.data;
        var messageObject = new Function("return" + strJSON)();
        console.log(messageObject);

        var sender = messageObject.sender;
        var receiver = messageObject.receiver;
        var content = messageObject.content;

        if (sender === currentChatID && receiver === "@ViewBag.username") {
            if ($('.chatarea-' + currentChatID).val() !== '') {
                $('.chatarea-' + currentChatID).val($('.chatarea-' + currentChatID).val() + '\n' + sender + ": " + content);
            } else {
                $('.chatarea-' + currentChatID).val(sender + ": " + content);
            }
        }
    };

    // when the connection is established, this method is called
    ws.onopen = function () {
        //inc.innerHTML += '.. connection open\n';
    };

    // when the connection is closed, this method is called
    ws.onclose = function () {
        //inc.innerHTML += '.. connection closed<br/>';
    }

}
window.onload = start;




    </script>
</body>
</html>
